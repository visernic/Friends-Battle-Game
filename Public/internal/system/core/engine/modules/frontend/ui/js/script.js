document.addEventListener("DOMContentLoaded",(()=>{const e={fps:60,winScore:10,colors:{p1:"#ff2a2a",p2:"#00ccff",frame:"#39ff14",bg:"#080808"},scytheUrl:"https://img.icons8.com/?size=100&id=6IyXfrxdkMa5&format=png&color=FFFFFF",coinUrl:"https://img.icons8.com/?size=100&id=A05obJXqB1TJ&format=png&color=000000"},t={x:80,y:550,w:920,h:920};let a,r={p1Img:null,p2Img:null,scytheImg:null,coinImg:null,p1Name:"",p2Name:"",p1Score:0,p2Score:0,frame:0,recording:!1,winner:0,shake:0,speedMult:1,balls:[],particles:[],coins:[]},o=[],l=null,i=1;const el=e=>document.getElementById(e),n={preview:el("previewCanvas"),render:el("renderCanvas"),start:el("startBtn"),p1ui:el("p1-ui-preview"),p2ui:el("p2-ui-preview"),name1:el("name1"),name2:el("name2"),video:el("finalVideo"),modal:el("importModal"),socialInput:el("socialUrlInput")};if(!n.preview||!n.render)return;const s=n.preview.getContext("2d"),c=n.render.getContext("2d"),loadAsset=e=>{const t=new Image;return t.crossOrigin="anonymous",t.src=e,t};function loadImg(e,t){const a=e.target.files[0];if(!a)return;const o=new FileReader;o.onload=e=>{const a=new Image;a.onload=()=>{1===t?(r.p1Img=a,n.p1ui.style.backgroundImage=`url(${e.target.result})`):(r.p2Img=a,n.p2ui.style.backgroundImage=`url(${e.target.result})`),checkReady(),drawStaticPreview()},a.src=e.target.result},o.readAsDataURL(a)}function checkReady(){r.p1Img&&r.p2Img&&(n.start.disabled=!1)}function drawStaticPreview(){drawBackground(s,540,960),s.strokeStyle=e.colors.frame,s.lineWidth=4,s.strokeRect(40,275,460,460),s.fillStyle="white",s.font='bold 20px "Hind Siliguri"',s.textAlign="center",s.fillText("Ready to Battle...",270,500)}function animate(){if(!r.recording)return;!function updatePhysics(){r.shake>0&&(r.shake*=.9);if(r.winner>0)return void updateEffects();r.speedMult=Math.min(2,1+5e-4*r.frame),r.balls.forEach((e=>{e.angle+=.25*r.speedMult,e.trail.push({x:e.x,y:e.y}),e.trail.length>15&&e.trail.shift(),e.x+=e.vx*r.speedMult,e.y+=e.vy*r.speedMult;const a=30;e.x-e.r-a<t.x&&(e.x=t.x+e.r+a,e.vx*=-1),e.x+e.r+a>t.x+t.w&&(e.x=t.x+t.w-e.r-a,e.vx*=-1),e.y-e.r-a<t.y&&(e.y=t.y+e.r+a,e.vy*=-1),e.y+e.r+a>t.y+t.h&&(e.y=t.y+t.h-e.r-a,e.vy*=-1)}));const a=r.balls[0],o=r.balls[1],l=o.x-a.x,i=o.y-a.y,n=Math.sqrt(l*l+i*i),s=a.r+o.r+30;if(n<s){r.shake=20,a.angle+=.5,o.angle-=.5;const t=Math.atan2(i,l),c=Math.sin(t),d=Math.cos(t),p=a.vx*d+a.vy*c,f=a.vy*d-a.vx*c,m=o.vx*d+o.vy*c,h=o.vy*d-o.vx*c;a.vx=m*d-f*c,a.vy=f*d+m*c,o.vx=p*d-h*c,o.vy=h*d+p*c;const g=s-n;a.x-=g/2*Math.cos(t),a.y-=g/2*Math.sin(t),o.x+=g/2*Math.cos(t),o.y+=g/2*Math.sin(t),function spawnSparks(e,t){for(let a=0;a<15;a++)r.particles.push({x:e,y:t,vx:20*(Math.random()-.5),vy:20*(Math.random()-.5),life:1,c:Math.random()>.5?"#fff":"#ffff00"})}((a.x+o.x)/2,(a.y+o.y)/2),Math.random()>.5?r.p1Score++:r.p2Score++,r.p1Score>=e.winScore?triggerWin(1):r.p2Score>=e.winScore&&triggerWin(2)}updateEffects()}(),function drawScene(a,o,l){let i=(Math.random()-.5)*r.shake,n=(Math.random()-.5)*r.shake;a.save(),a.translate(i,n),drawBackground(a,o,l),a.shadowBlur=30,a.shadowColor=e.colors.frame,a.strokeStyle=e.colors.frame,a.lineWidth=15,a.strokeRect(t.x,t.y,t.w,t.h),a.shadowBlur=0,function drawUI(t,a){const o=280,l=220,i=a-220;t.font="900 130px Bangers",t.fillStyle="#fff",t.strokeStyle="#000",t.lineWidth=8,t.textAlign="center",t.strokeText("VS",a/2,o+50),t.fillText("VS",a/2,o+50),t.font="900 120px Roboto",t.fillStyle=e.colors.p1,t.fillText(r.p1Score,l,o+180),t.fillStyle=e.colors.p2,t.fillText(r.p2Score,i,o+180),drawPlayerProfile(t,l,o,r.p1Img,r.p1Name,e.colors.p1),drawPlayerProfile(t,i,o,r.p2Img,r.p2Name,e.colors.p2)}(a,o),r.balls.forEach(((e,t)=>{const o=t+1,l=0!==r.winner&&r.winner!==o;if(a.save(),l){let e=Math.max(0,1-(r.frame-r.winFrame)/60);a.globalAlpha=e}!function drawBall(e,t,a){e.save(),e.translate(t.x,t.y),e.rotate(t.angle),r.scytheImg?(e.shadowColor=t.c,e.shadowBlur=20,e.drawImage(r.scytheImg,t.r-20,-60,140,120),e.shadowBlur=0):(e.fillStyle="#fff",e.fillRect(t.r,-5,100,10));e.rotate(-t.angle),e.rotate(t.angle),e.beginPath(),e.arc(0,0,t.r,0,2*Math.PI),e.clip(),a?e.drawImage(a,-t.r,-t.r,2*t.r,2*t.r):(e.fillStyle="#444",e.fill());e.beginPath(),e.arc(0,0,t.r,0,2*Math.PI),e.lineWidth=5,e.strokeStyle=t.c,e.stroke(),e.restore()}(a,e,0===t?r.p1Img:r.p2Img),a.restore()})),a.globalCompositeOperation="lighter";for(let e of r.particles)a.globalAlpha=e.life,a.fillStyle=e.c,a.beginPath(),a.arc(e.x,e.y,5,0,2*Math.PI),a.fill();a.globalCompositeOperation="source-over",a.globalAlpha=1;for(let e of r.coins)a.save(),a.translate(e.x,e.y),a.rotate(e.rot),r.coinImg?(a.shadowBlur=10,a.shadowColor=e.tint,a.drawImage(r.coinImg,-30,-30,60,60)):(a.fillStyle=e.tint,a.beginPath(),a.arc(0,0,30,0,2*Math.PI),a.fill()),a.restore();r.winner>0&&function drawWinScreen(t,a,o){const l=r.winner,i=1===l?e.colors.p1:e.colors.p2,n=1===l?r.p1Name:r.p2Name,s=1===l?r.p1Img:r.p2Img;t.fillStyle="rgba(0,0,0,0.85)";let c=Math.min(.85,(r.frame-r.winFrame)/30);t.globalAlpha=c,t.fillRect(0,0,a,o),t.globalAlpha=1,t.save(),t.translate(a/2,600),t.rotate(.01*r.frame);const d=t.createRadialGradient(0,0,50,0,0,800);d.addColorStop(0,i),d.addColorStop(1,"transparent"),t.fillStyle=d,t.globalAlpha=.3;for(let e=0;e<8;e++)t.rotate(Math.PI/4),t.beginPath(),t.moveTo(0,0),t.lineTo(-100,1e3),t.lineTo(100,1e3),t.fill();t.restore(),t.globalAlpha=1,t.shadowColor=i,t.shadowBlur=60,drawPlayerProfile(t,a/2,600,s,"",i),t.shadowBlur=0,t.font="200px Arial",t.textAlign="center",t.fillText("ðŸ‘‘",a/2,380),t.font="900 130px Bangers",t.fillStyle="#ffd700",t.fillText("WINNER!",a/2,850),t.font='bold 80px "Hind Siliguri"',t.fillStyle="white",t.fillText(n,a/2,980)}(a,o,l);a.restore()}(c,1080,1920),s.drawImage(n.render,0,0,540,960),r.frame++;let o=Math.max(r.p1Score,r.p2Score)/e.winScore*100;r.winner>0&&(o=99),el("progressBar").style.width=`${o}%`,el("percentText").innerText=`${Math.floor(o)}%`,r.winner>0&&r.frame-r.winFrame>240?(a.stop(),r.recording=!1):(r.frame>18e3&&0===r.winner&&function forceWin(){r.p1Score>r.p2Score?triggerWin(1):r.p2Score>r.p1Score?triggerWin(2):triggerWin(Math.random()>.5?1:2)}(),requestAnimationFrame(animate))}function triggerWin(e){if(0===r.winner){r.winner=e,r.winFrame=r.frame;for(let e=0;e<100;e++){let e="#FFD700";const t=Math.random();t>.6?e="#C0C0C0":t>.3&&(e="#B76E79"),r.coins.push({x:1080*Math.random(),y:1e3*-Math.random()-50,vy:10*Math.random()+5,vx:4*(Math.random()-.5),rot:6.28*Math.random(),rotSpeed:.2*(Math.random()-.5),tint:e})}}}function updateEffects(){for(let e=r.particles.length-1;e>=0;e--){let t=r.particles[e];t.x+=t.vx,t.y+=t.vy,t.life-=.05,t.life<=0&&r.particles.splice(e,1)}for(let e of r.coins)e.y+=e.vy,e.x+=e.vx,e.rot+=e.rotSpeed,e.y>2e3&&(e.y=-200)}function drawBackground(e,t,a){const r=e.createRadialGradient(t/2,a/2,100,t/2,a/2,a);r.addColorStop(0,"#1a1a2e"),r.addColorStop(1,"#000000"),e.fillStyle=r,e.fillRect(-20,-20,t+40,a+40),e.strokeStyle="rgba(57, 255, 20, 0.05)",e.lineWidth=2,e.beginPath();for(let o=0;o<=t;o+=120)e.moveTo(o,0),e.lineTo(o,a);for(let o=0;o<=a;o+=120)e.moveTo(0,o),e.lineTo(t,o);e.stroke(),e.fillStyle="rgba(255, 255, 255, 0.2)";for(let o=0;o<30;o++){let r=1e4*Math.sin(132.1*o)%t;r<0&&(r+=t);let l=1e4*Math.cos(453.2*o)%a;l<0&&(l+=a),e.beginPath(),e.arc(r,l,3*Math.random(),0,2*Math.PI),e.fill()}}function drawPlayerProfile(e,t,a,r,o,l){const i=90;e.save(),e.beginPath(),e.arc(t,a,i,0,2*Math.PI),e.clip(),r?e.drawImage(r,t-i,a-i,180,180):(e.fillStyle="#333",e.fill()),e.restore(),e.beginPath(),e.arc(t,a,i,0,2*Math.PI),e.lineWidth=6,e.strokeStyle=l,e.stroke(),e.font='bold 45px "Hind Siliguri"',e.textAlign="center",e.textBaseline="bottom",e.fillStyle=l,e.shadowColor="black",e.shadowBlur=10,e.fillText(o,t,a-i-15),e.shadowBlur=0}function finishRecording(){const e=new Blob(o,{type:"video/mp4"});l=URL.createObjectURL(e),el("processingUI").classList.add("hidden"),el("resultUI").classList.remove("hidden"),el("progressBar").style.width="100%",n.start.disabled=!1}r.scytheImg=loadAsset(e.scytheUrl),r.coinImg=loadAsset(e.coinUrl),r.scytheImg.onload=()=>drawStaticPreview(),el("upload1").addEventListener("change",(e=>loadImg(e,1))),el("upload2").addEventListener("change",(e=>loadImg(e,2))),n.start.addEventListener("click",(function startBattle(){r.p1Name=n.name1.value.trim()||"Player 1",r.p2Name=n.name2.value.trim()||"Player 2",n.start.disabled=!0,el("resultUI").classList.add("hidden"),el("processingUI").classList.remove("hidden"),n.video.classList.add("hidden"),n.video.pause(),r.p1Score=0,r.p2Score=0,r.frame=0,r.winner=0,r.recording=!0,r.particles=[],r.coins=[],r.balls=[{x:300,y:700,vx:12,vy:-12,r:60,c:e.colors.p1,trail:[],angle:0},{x:780,y:700,vx:-12,vy:12,r:60,c:e.colors.p2,trail:[],angle:Math.PI}];const t=n.render.captureStream(e.fps);let l=MediaRecorder.isTypeSupported("video/mp4")?"video/mp4":"video/webm;codecs=vp9";a=new MediaRecorder(t,{mimeType:l,videoBitsPerSecond:12e6}),o=[],a.ondataavailable=e=>{e.data.size>0&&o.push(e.data)},a.onstop=finishRecording,a.start(),animate()})),window.openImportModal=(e,t)=>{i=e,n.modal.classList.remove("hidden"),el("modalPlatform").innerText="tiktok"===t?"TikTok":"Facebook",n.socialInput.value="",n.socialInput.focus()},window.closeImportModal=()=>{n.modal.classList.add("hidden")},window.submitImport=()=>{const e=n.socialInput.value.trim();if(!e)return void window.closeImportModal();let t=e.substring(0,10);if(e.includes("tiktok.com")){const a=e.match(/@([a-zA-Z0-9_.]+)/);a&&(t=a[1])}else if(e.includes("facebook.com")){const a=e.split("/");t=(a[a.length-1]||a[a.length-2]).replace("/","")}1===i?n.name1.value=t:n.name2.value=t;const a=`https://ui-avatars.com/api/?name=${t}&background=random&color=fff&size=200&font-size=0.5`,o=new Image;o.crossOrigin="anonymous",o.onload=()=>{1===i?(r.p1Img=o,n.p1ui.style.backgroundImage=`url(${a})`):(r.p2Img=o,n.p2ui.style.backgroundImage=`url(${a})`),checkReady(),drawStaticPreview()},o.src=a,window.closeImportModal()},window.shareApp=async()=>{if(navigator.share)try{await navigator.share({title:"Battle Maker",url:window.location.href})}catch(e){}else alert("Link Copied!"),navigator.clipboard.writeText(window.location.href)},window.previewRecordedVideo=()=>{n.video.src=l,n.video.classList.remove("hidden"),n.video.play()},window.downloadVideo=()=>{const e=document.createElement("a");e.style.display="none",e.href=l,e.download=`Battle_${r.p1Name}_VS_${r.p2Name}.mp4`,document.body.appendChild(e),e.click(),setTimeout((()=>document.body.removeChild(e)),100)},drawStaticPreview()}));
